name: Backend Pipeline
on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Connect to server and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          script: |
            eval $(ssh-agent)
            ssh-add /home/ubuntu/.ssh/id_rsa
            cd /home/ubuntu/velo-legal
            git pull
            docker rm $(docker ps -aq)
            cd back
            docker build -t velo-legal-api .
            docker run -d -p 80:80 --name velo-legal-api velo-legal-api 
            rm -rf vendor
            docker exec velo-legal-api apt update
            docker exec velo-legal-api apt install git
            docker exec velo-legal-api php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            docker exec velo-legal-api php -r "if (hash_file('sha384', 'composer-setup.php') === 'e21205b207c3ff031906575712edab6f13eb0b361f2085f1f1237b7126d785e826a450292b6cfd1d64d92e6563bbde02') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
            docker exec velo-legal-api php composer-setup.php
            docker exec velo-legal-api php -r "unlink('composer-setup.php');"
            docker exec velo-legal-api php composer.phar install
            docker exec velo-legal-api php artisan migrate
